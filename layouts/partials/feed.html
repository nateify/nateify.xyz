{{- $pctx := . -}}
{{- if .IsHome }}{{ $pctx = .Site }}{{ end -}}

{{- $rawTitle := site.Title -}}
{{- if and (not .IsHome) .Title -}}
    {{- $rawTitle = printf "%s | %s" .Title site.Title -}}
{{- end -}}
{{- $feedTitle := $rawTitle | transform.XMLEscape -}}

{{- $authorName := site.Params.author.name | default site.Params.author -}}
{{- $authorEmail := site.Params.author.email -}}
{{- $copyright := "" -}}
{{- with site.Copyright -}}
  {{- $notice := printf . $authorName (site.Params.licenseName | default "") -}}
  {{- $copyright = replace $notice "{year}" now.Year | plainify -}}
{{- end -}}

{{- $pages := slice -}}
{{- if or $.IsHome $.IsSection -}}
    {{- $pages = $pctx.RegularPages -}}
{{- else -}}
    {{- $pages = $pctx.Pages -}}
{{- end -}}

{{- $pages = where $pages ".Params.disable_feed" "!=" true -}}
{{- $pages = where $pages ".Params.unlisted" "!=" true -}}

{{- $pages = $pages.ByLastmod.Reverse -}}

{{- $limit := site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
    {{- $pages = $pages | first $limit -}}
{{- end -}}

{{- return dict
    "Pages" $pages
    "FeedTitle" $feedTitle
    "FeedTitleRaw" $rawTitle
    "AuthorName" $authorName
    "AuthorEmail" $authorEmail
    "Copyright" $copyright
    "BuildDate" (now.Format "2006-01-02T15:04:05-07:00")
-}}
