{{- $data := partial "feed.html" . -}}
{{ printf `<?xml version="1.0" encoding="utf-8"?>` | safeHTML }}
<feed xmlns="http://www.w3.org/2005/Atom"{{ with site.LanguageCode }} xml:lang="{{ . }}"{{ end }}>
    <title type="text">{{ $data.FeedTitle | safeHTML }}</title>
    {{ $output_formats := .OutputFormats }}
    {{ range $output_formats -}}
        {{- $rel := (or (and (eq "atom" (.Name | lower)) "self") "alternate") -}}
        {{ with $output_formats.Get .Name }}
            {{ printf `<link href=%q rel=%q type=%q title=%q />` .Permalink $rel .MediaType.Type $.Site.Title | safeHTML }}
        {{- end -}}
    {{- end }}
    {{- with .Param "feed.hub" -}}
        {{ printf `<link href=%q rel="hub" />` . | safeHTML }}
    {{- end -}}
    <generator uri="https://gohugo.io/" version="{{ hugo.Version }}">Hugo</generator>
    <updated>{{ now.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</updated>
    {{ with $data.Copyright }}<rights>{{ . }}</rights>{{ end }}
    {{- with .Param "feed.icon" -}}
        <icon>{{ . | absURL }}</icon>
    {{- end -}}
    {{ with $data.AuthorName }}
        <author>
            <name>{{ . }}</name>
            {{ with $data.AuthorEmail }}<email>{{ . }}</email>{{ end }}
        </author>
    {{ end }}
    {{ with site.Params.id }}
        <id>urn:uuid:{{ . | plainify }}</id>
    {{ else }}
        <id>{{ .Permalink }}</id>
    {{ end }}
    {{ range $data.Pages }}
        <entry>
            <title type="text">{{ .Title }}</title>
            <link href="{{ .Permalink }}" rel="alternate" type="text/html" />
            <id>{{ if .Params.uuid }}urn:uuid:{{ .Params.uuid }}{{ else }}{{ .Permalink }}{{ end }}</id>
            {{ with $data.AuthorName }}
                <author>
                    <name>{{ . }}</name>
                </author>
            {{ end }}
            <published>{{ .Date.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</published>
            <updated>{{ .Lastmod.Format "2006-01-02T15:04:05-07:00" | safeHTML }}</updated>
            {{ $content := .Content
                | replaceRE "src=\"/" (printf "src=\"%s/" .Site.BaseURL)
                | replaceRE "href=\"/" (printf "href=\"%s/" .Site.BaseURL)
                | replaceRE "href=\"#" (printf "href=\"%s#" .Permalink)
            }}
            {{ printf "<content type=\"html\"><![CDATA[%s]]></content>" $content | safeHTML }}
            {{- $currentPage := . -}}
            {{- with site.Taxonomies -}}
                {{- range $taxo, $_ := . -}}
                    {{- with $currentPage.Param $taxo -}}
                        {{- range . -}}
                            <category scheme="{{ (site.GetPage $taxo).Permalink }}" term="{{ . | urlize }}" label="{{ . }}" />
                        {{- end -}}
                    {{- end -}}
                {{- end -}}
            {{- end -}}
        </entry>
    {{ end }}
</feed>
